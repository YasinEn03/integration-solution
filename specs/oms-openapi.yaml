openapi: 3.0.3
info:
  title: Shop AG
  version: 1.1.1
  description: |
    Gemeinsame OpenAPI-Spezifikation für Order Management Service (OMS)
    und Payment Service. Für lokale Swagger-Tests sind die Server-URLs
    bereits CORS-sicher gesetzt (OMS relativ, Payments absolut auf localhost:3001).

servers:
  - url: /api
    description: Local OMS

tags:
  - name: OMS
    description: Order Management Endpunkte
  - name: Payments
    description: Payment Endpunkte

paths:
  /orders:
    post:
      tags: [OMS]
      summary: Auftrag anlegen
      operationId: createOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      productId:
                        type: integer
                      quantity:
                        type: integer
                firstName:
                  type: string
                lastName:
                  type: string
              required:
                - items
                - firstName
                - lastName
            examples:
              orderErfolgreich:
                summary: Erfolgreiche Bestellung
                value:
                  items:
                    - productId: 102
                      quantity: 1
                    - productId: 101
                      quantity: 2
                  firstName: Niklas
                  lastName: Osimhen
              reservierungFehlgeschlagen:
                summary: Reservierung fehlgeschlagen
                value:
                  items:
                    - productId: 101
                      quantity: 1
                    - productId: 103
                      quantity: 12
                  firstName: Niklas
                  lastName: Osimhen
              zahlungFehlgeschlagen:
                summary: Bestellung angelegt, Zahlung schlägt fehl
                value:
                  items:
                    - productId: 101
                      quantity: 1
                    - productId: 103
                      quantity: 3
                  firstName: Maxi
                  lastName: Icardi
      responses:
        '201':
          description: Order erfolgreich angelegt
        '400':
          description: Ungültige Eingabe
        '409':
          description: Konflikt (z.B. doppelte Bestellung)
        '422':
          description: Reservierung fehlgeschlagen

  /orders/{orderId}:
    get:
      tags: [OMS]
      summary: Auftrag abrufen
      operationId: getOrder
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  orderId:
                    type: string
                  status:
                    type: string
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        productId:
                          type: integer
                        quantity:
                          type: integer
        '404':
          description: Order nicht gefunden

  /payments:
    post:
      tags: [Payments]
      summary: Zahlung anlegen (Authorize + optional Capture)
      operationId: createPayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                orderId:
                  type: string
                amount:
                  type: number
                  format: float
                currency:
                  type: string
                capture:
                  type: boolean
                  default: true
                method:
                  type: object
                  properties:
                    type:
                      type: string
                      enum: [CARD, SEPA, PAYPAL, MOCK]
                    token:
                      type: string
                metadata:
                  type: object
                  additionalProperties: true
            examples:
              zahlungErfolgreich:
                summary: Zahlung erfolgreich
                value:
                  orderId: '1'
                  amount: 150.00
                  currency: EUR
                  capture: true
                  method:
                    type: MOCK
                    token: 'token123'
              zahlungFehlgeschlagen:
                summary: Zahlung abgelehnt
                value:
                  orderId: '3'
                  amount: 300.00
                  currency: EUR
                  capture: true
                  method:
                    type: MOCK
                    token: 'fail_token'
      responses:
        '201':
          description: Zahlung erfolgreich angelegt
        '402':
          description: Zahlung abgelehnt
        '400':
          description: Ungültige Eingabe

    get:
      tags: [Payments]
      summary: Zahlungen auflisten
      operationId: listPayments
      responses:
        '200':
          description: Liste aller Zahlungen
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    paymentId: { type: string }
                    orderId: { type: string }
                    status: { type: string }
                    amount: { type: number, format: float }

  /payments/{paymentId}/capture:
    post:
      tags: [Payments]
      summary: Zahlung capturen
      operationId: capturePayment
      parameters:
        - name: paymentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Zahlung erfolgreich capturt
        '404':
          description: Zahlung nicht gefunden
        '409':
          description: Konflikt

  /payments/{paymentId}/refund:
    post:
      tags: [Payments]
      summary: Zahlung (teil-)erstatten
      operationId: refundPayment
      parameters:
        - name: paymentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: number
                  format: float
                  description: Optional, fehlend = Vollrefund
      responses:
        '200':
          description: Zahlung erfolgreich refundiert
        '404':
          description: Zahlung nicht gefunden
        '409':
          description: Konflikt
